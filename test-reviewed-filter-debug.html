<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reviewed Filter Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-title {
            color: #2563eb;
            border-bottom: 2px solid #2563eb;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .test-item {
            margin: 10px 0;
            padding: 10px;
            background: #f8fafc;
            border-left: 4px solid #2563eb;
            border-radius: 4px;
        }
        .success { border-left-color: #10b981; }
        .warning { border-left-color: #f59e0b; }
        .error { border-left-color: #ef4444; }
        .code {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            overflow-x: auto;
        }
        .debug-info {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .api-response {
            background: #e0f2fe;
            border: 1px solid #0891b2;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>🔧 Reviewed Filter Debug Test</h1>
    
    <div class="test-section">
        <h2 class="test-title">🐛 Issues Fixed</h2>
        
        <div class="test-item success">
            <h3>1. Backend Response Structure Issue</h3>
            <p><strong>Problem:</strong> Backend trả về response với wrapper structure:</p>
            <div class="code">
{
  "success": true,
  "canReview": boolean,
  "hasReviewed": boolean
}
            </div>
            <p><strong>Solution:</strong> Frontend đã được cập nhật để handle đúng response structure:</p>
            <div class="code">
// Handle backend response structure
const reviewData = response.data?.success ? {
  canReview: response.data.canReview,
  hasReviewed: response.data.hasReviewed
} : response.data
            </div>
        </div>

        <div class="test-item success">
            <h3>2. TypeScript Interface Issue</h3>
            <p><strong>Problem:</strong> TypeScript interface không match với backend response</p>
            <p><strong>Solution:</strong> Đã thêm interface mới:</p>
            <div class="code">
export interface CanReviewApiResponse {
  success: boolean
  canReview: boolean
  hasReviewed: boolean
  message?: string
}
            </div>
        </div>

        <div class="test-item success">
            <h3>3. Debug Logging Added</h3>
            <p>Đã thêm comprehensive debug logging để track:</p>
            <ul>
                <li>API response structure</li>
                <li>Review status loading process</li>
                <li>Filter logic execution</li>
                <li>Appointment filtering results</li>
            </ul>
        </div>
    </div>

    <div class="test-section">
        <h2 class="test-title">🔍 Debug Information Added</h2>
        
        <div class="test-item">
            <h3>Debug Panel on UI</h3>
            <p>Đã thêm debug panel trên UI để hiển thị:</p>
            <ul>
                <li>Current filter status</li>
                <li>Total appointments count</li>
                <li>Review status loaded count</li>
                <li>Detailed review status data (when REVIEWED filter is active)</li>
            </ul>
        </div>

        <div class="test-item">
            <h3>Console Logging</h3>
            <p>Comprehensive console logging cho:</p>
            <ul>
                <li>🔍 Review status API calls</li>
                <li>🔍 Response processing</li>
                <li>🔍 Filter logic execution</li>
                <li>🔍 Appointment filtering results</li>
            </ul>
        </div>
    </div>

    <div class="test-section">
        <h2 class="test-title">🧪 Testing Instructions</h2>
        
        <div class="test-item">
            <h3>Step 1: Check Debug Panel</h3>
            <ol>
                <li>Navigate to <code>http://localhost:3000/user/appointments</code></li>
                <li>Look for the "Debug Info" panel at the top</li>
                <li>Check that "Review status loaded" shows a number > 0</li>
                <li>This indicates API calls are working</li>
            </ol>
        </div>

        <div class="test-item">
            <h3>Step 2: Test Reviewed Filter</h3>
            <ol>
                <li>Click on "Reviewed" filter button</li>
                <li>Check debug panel shows "REVIEWED Filter Debug" section</li>
                <li>Look at the JSON data to see review status details</li>
                <li>Verify appointments are filtered correctly</li>
            </ol>
        </div>

        <div class="test-item">
            <h3>Step 3: Check Console Logs</h3>
            <ol>
                <li>Open browser DevTools (F12)</li>
                <li>Go to Console tab</li>
                <li>Look for debug messages starting with 🔍</li>
                <li>Check API response structure</li>
                <li>Verify filter logic execution</li>
            </ol>
        </div>
    </div>

    <div class="test-section">
        <h2 class="test-title">📊 Expected Debug Output</h2>
        
        <div class="debug-info">
            <h3>Console Debug Messages</h3>
            <div class="code">
🔍 Loading review status for appointment 123
🔍 Review status response for appointment 123: {success: true, canReview: false, hasReviewed: true}
🔍 Processed review data for appointment 123: {canReview: false, hasReviewed: true}
🔍 Updated appointmentReviewStatus: {123: {canReview: false, hasReviewed: true}}

🔍 REVIEWED filter - appointmentReviewStatus: {123: {canReview: false, hasReviewed: true}}
🔍 REVIEWED filter - appointmentsList: [appointment objects...]
🔍 Appointment 123: {status: "COMPLETED", isCompleted: true, hasReviewStatus: true, reviewStatus: {canReview: false, hasReviewed: true}, isReviewed: true}
🔍 REVIEWED filter - filtered result: [filtered appointments...]
            </div>
        </div>

        <div class="api-response">
            <h3>API Response Structure</h3>
            <div class="code">
// Backend Response
{
  "success": true,
  "canReview": false,
  "hasReviewed": true
}

// Frontend Processing
{
  canReview: false,
  hasReviewed: true
}
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2 class="test-title">🔧 Filter Logic</h2>
        
        <div class="test-item">
            <h3>Reviewed Filter Logic</h3>
            <div class="code">
} else if (filterStatus === "REVIEWED") {
    // Filter for completed appointments that have been reviewed
    const filtered = appointmentsList.filter(apt => {
        const isCompleted = apt.status === "COMPLETED"
        const hasReviewStatus = appointmentReviewStatus[apt.id]
        const isReviewed = hasReviewStatus && appointmentReviewStatus[apt.id].hasReviewed
        
        return isCompleted && hasReviewStatus && isReviewed
    })
    setAppointments(filtered)
}
            </div>
        </div>

        <div class="test-item">
            <h3>Conditions for Review Filter</h3>
            <ul>
                <li><strong>isCompleted:</strong> appointment.status === "COMPLETED"</li>
                <li><strong>hasReviewStatus:</strong> appointmentReviewStatus[apt.id] exists</li>
                <li><strong>isReviewed:</strong> appointmentReviewStatus[apt.id].hasReviewed === true</li>
            </ul>
        </div>
    </div>

    <div class="test-section">
        <h2 class="test-title">✅ Verification Checklist</h2>
        
        <div class="test-item success">
            <h3>Backend Response Handling ✅</h3>
            <ul>
                <li>✅ CanReviewApiResponse interface added</li>
                <li>✅ Response structure properly handled</li>
                <li>✅ TypeScript errors resolved</li>
                <li>✅ API response parsing fixed</li>
            </ul>
        </div>

        <div class="test-item success">
            <h3>Debug Information ✅</h3>
            <ul>
                <li>✅ Debug panel added to UI</li>
                <li>✅ Console logging implemented</li>
                <li>✅ Review status tracking</li>
                <li>✅ Filter logic debugging</li>
            </ul>
        </div>

        <div class="test-item success">
            <h3>Filter Logic ✅</h3>
            <ul>
                <li>✅ REVIEWED filter logic implemented</li>
                <li>✅ Proper condition checking</li>
                <li>✅ Debug logging for filter execution</li>
                <li>✅ Response handling for review status</li>
            </ul>
        </div>
    </div>

    <div class="test-section">
        <h2 class="test-title">🚨 Troubleshooting</h2>
        
        <div class="test-item error">
            <h3>If Reviewed Filter Still Shows No Data</h3>
            <ol>
                <li><strong>Check Debug Panel:</strong> Ensure "Review status loaded" > 0</li>
                <li><strong>Check Console:</strong> Look for API errors or failed requests</li>
                <li><strong>Verify Backend:</strong> Ensure appointments have been reviewed</li>
                <li><strong>Check API Response:</strong> Verify response structure matches expected format</li>
            </ol>
        </div>

        <div class="test-item warning">
            <h3>Common Issues</h3>
            <ul>
                <li><strong>No completed appointments:</strong> Need appointments with status "COMPLETED"</li>
                <li><strong>API errors:</strong> Check network tab for failed requests</li>
                <li><strong>Authentication issues:</strong> Ensure user is logged in</li>
                <li><strong>Backend service issues:</strong> Check backend logs for errors</li>
            </ul>
        </div>
    </div>

    <script>
        function testReviewedFilter() {
            console.log('Testing Reviewed Filter Logic');
            
            // Mock data
            const mockAppointments = [
                { id: 1, status: 'COMPLETED' },
                { id: 2, status: 'COMPLETED' },
                { id: 3, status: 'PENDING' }
            ];
            
            const mockReviewStatus = {
                1: { canReview: false, hasReviewed: true },
                2: { canReview: true, hasReviewed: false },
                3: { canReview: false, hasReviewed: false }
            };
            
            // Filter logic
            const filtered = mockAppointments.filter(apt => {
                const isCompleted = apt.status === "COMPLETED"
                const hasReviewStatus = mockReviewStatus[apt.id]
                const isReviewed = hasReviewStatus && mockReviewStatus[apt.id].hasReviewed
                
                console.log(`Appointment ${apt.id}:`, {
                    status: apt.status,
                    isCompleted,
                    hasReviewStatus,
                    reviewStatus: mockReviewStatus[apt.id],
                    isReviewed
                });
                
                return isCompleted && hasReviewStatus && isReviewed
            });
            
            console.log('Filtered result:', filtered);
            alert(`Reviewed filter test completed. Check console for details. Result: ${filtered.length} appointments`);
        }

        function testApiResponse() {
            console.log('Testing API Response Structure');
            
            const mockApiResponse = {
                success: true,
                canReview: false,
                hasReviewed: true
            };
            
            // Processing logic
            const reviewData = mockApiResponse?.success ? {
                canReview: mockApiResponse.canReview,
                hasReviewed: mockApiResponse.hasReviewed
            } : mockApiResponse;
            
            console.log('Original API Response:', mockApiResponse);
            console.log('Processed Review Data:', reviewData);
            
            alert('API response test completed. Check console for details.');
        }
    </script>

    <div class="test-section">
        <h2 class="test-title">🧪 Test Functions</h2>
        <button onclick="testReviewedFilter()" style="background: #2563eb; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; margin: 5px;">
            Test Reviewed Filter Logic
        </button>
        <button onclick="testApiResponse()" style="background: #059669; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; margin: 5px;">
            Test API Response Structure
        </button>
    </div>
</body>
</html>
